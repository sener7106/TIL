	# 프로젝트2 - 스마트카드 데이터 대중교통망 Circuity 활용

### 문제 제시 배경 (1)

* 최근 도시 팽창으로 인해 교통혼잡이 날로 증가하여 사회 문제로 부상하고 있다. 이를 해결하기 위해 '통합거리 비례제'를 실시해 버스, 지하철, 버스-지하철 이러한 환승통행이 이루어지고 있다. 이에 대한 해결책의 일환으로 시장에서는 고객의 요구와 수요에 대응하는 '주문형 서비스'인 '온디맨드 서비스'가 생겨나고 있다. 이 서비스에 대한 논의가 활발하게 이루어지고 있는 와중에, 이를 활용한 MaaS 플랫폼이 다수 출시되고 있다. 서울시 내 혼잡지역을 파악해 어느 지역에 '온디맨드 서비스'를 실시하면 좋을지, 궁극적으로 어떻게 하면 교통혼잡을 줄일 수 있을지 라는 생각으로 이 프로젝트를 시작하였다.

- MaaS란, Mobility as a Service 의 약자로, 하나의 플랫폼에 예약및 결제와 같은 다수의 서비스를 제공하는 것을 말함.
- ex) 우버, 카카오티, 따릉이, 공유킥보드 등.. (그림1)

### 프로젝트 개요 (3)

* 수요와 공급에 따른 교통수단별 Circuity(우회계수)를 확인하고, 취약지점을 파악해 수요가 필요한 지점에 서비스를 하는 것이 중요하다.
- 우회계수란? 네트워크 통행거리와 직선거리에 대한 비로서 경로의 우회되는 정도에 따른 수입니다. 차후 피피티에서 설명하겠습니다.
- 저희 조는 maas 서비스 중 공유자전거 , 공유 킥보드 등 LM(last mile), FM(first mile)의 단거리 데이터에 대해서 조사를 하기로 주제를 정했습니다.
- 통계적으로 공유킥보드의 평균 이용시간은 9분으로, 이동거리는 1.6km이라고 알려져있습니다. 여기서 1.6km는 1mile에 해당하는 거리로, 주 이용시간대는 출근시간과 퇴근시간대에 주로 집중되있는 것으로 설문조사 결과 예측되었습니다.(논문, 그림 발췌)

### 프로젝트 목적 (2)

* Smart Card 데이터를 활용하여 서울특별시 내의 대중교통 취약지점을 확인하고, 온디맨드 서비스의 최적 입지에 대해 분석한다.


### 예상 기대효과

* 혼잡한 지점, 평균 대기시간이 긴 지점 주변을 공략하면 인원이 분산되는 효과를 얻을 수 있을 것이다.
* 대중교통이 미비한 지점, 역과의 거리가 너무 먼 지점 등은 택시 등을 이용하게 되므로, 이 지점에 온디맨드 서비스가 생긴다면 효과를 볼 수 있을 것이다.
* Circuity가 큰 지점은 그만큼 우회해서 간다는 뜻이므로 시간이 오래 걸린다. Circuity와 관련된 분석을 통해 소비자의 요구를 효율적으로 해결할 수 있는 온디맨드 서비스가 필요한 지점을 파악하여 소비자의 수요와 불편을 해결할 수 있을 것이다.

### 분석 절차 (4)

- 실제 통행 기록인 스마트 카드 데이터를 활용하여 서울시 내 대중교통 취약지점을 파악한다. 이를 활용해 온디맨드 서비스가 어느 지점에서 실시되면 좋을지 파악한다.
- 데이터를 정제하고, 지도 상에 시각화하여 서울시 내 25개 구에 대한 Circuity 빈도를 파악한다.
-  시각화를 통해 어느 지역을 중심으로 파악하면 좋을지 생각해본다. Circuity(우회계수)의 빈도가 높은 4개의 구를 중심으로 세부적인 내용을 분석한다.
- 위도, 경도 데이터를 활용한 대중교통 이용 고객의 루트를 확인한다.
- 경로 검색 데이터를 시계열적으로 분석하면 교통수단 및 이용 장소 등의 변화를 유추할 수 있을 것이다.


### 분석과정 
0. 데이터 정제 : 결측치와 이상치를 처리, 데이터 시트 내에서 먼저 NaN에 해당하는 값과 garbage data를 전처리 과정 중 삭제하였습니다. 
- 전처리 과정 중 Circuity는 약 천만건 데이터 중, 3이상인 데이터가 7만건으로 통계적으로 약 0.07%의 비율을 가지고 있었습니다. 이에 해당하는 데이터를 분석한 결과, 저희의 분석 대상과는 거리가 있다고 생각되어 제거하였습니다. 또한, 1이하인 데이터는 
대중교통 취약점을 분석하기에는 적절하지 않다고 생각하여 고려 대상에서 배제하였습니다.

- 그리고, 자료 내에 교통정보가 부족한 점이 있었기 때문에, 서울공공데이터 포털을 참조하여 서울시 행정구역코드를 병합하였습니다.
1. 먼저 대중교통 내 우회계수에 대해서 설명드리겠습니다. 우회계수란, 네트워크 통행거리와 직선거리에 대한 비로서 경로의 우회되는 정도에 따른 수입니다. 여기서 네트워크 통행거리란, 다음예시와 같습니다. (그림) 이 네트워크 통행거리에 직선거리를 나눈 값은 1보다 클 수록 더 우회한다는 의미가 되겠습니다.

- 저희는 먼저 우회계수 파악을 통해 데이터 내에서 버스, 지하철, 버스-지하철 그룹으로 나눠 이에 대한 분석을 진행해보았습니다.
- 각 그룹내 평균은 1.2 ~ 1.3의 분포를 보였으며 그 중에는 버스-지하철 환승그룹이 가장 우회계수가 높게 나타났습니다. 이 이유로서는 지하철은 지하로 통행하기때문에 지리적 우회성이 적고 직선성이 높고, 버스의 경우 지리적으로 산이나 건물이 위치 되어 있는 경우
경로를 우회하게 됩니다. 버스 & 지하철은 환승을 하기 위한 도보 이동이나 다른 지리적요인으로 인하여 우회계수가 높게 나타나는 것으로 추론하였습니다.

2.  Folium을 통한 각 시군구별 우회계수 파악

저희는 파이썬 패키지 중 지도를 시각화 할 수 있는 Folium map을 이용하여 각 시군구별 우회계수 분포를 파악하였습니다.
분석결과, 서초구, 중랑구, 양천구, 서대문구의 총 4개 구에서 우회계수가 높게 분포되었음을 확인할 수 있었습니다.

저희는 이 네개의 구를 개별적으로 분석을 진행하였습니다.

- 각 구에 대한 box plot, bar-plot 결과,  전체적으로 비슷한 분포를 보였으나, 서대문구의 경우가 특히 Circuity가 높은 분포를 가지는 것으로 파악되었습니다. 이는 앞서 보여드린 folium 데이터와는 차이가 있을 수 있는데,
이는 각 구에 대하여 sample data에 대한 개수차이로 인한 것으로 판단되었습니다. (서초구 45만개, 타 3개구 20만개)

- 이용 시간 별 우회계수 추이

고객 총 이용 시간 30분내의 데이터 분석결과, 서대문구, 그리고 양천구에서 Circuity가 높게 나타나는 것을 확인할 수 있었습니다.

- 이용 시간 별 고객 수 카운트 

이용시간 별 고객 수 분석 결과, 서초구에서 가장 많은 사람이 이용을 하는 것을 확인할 수 있었고, 5~15분 사이 많은 고객들이 이용을 하는 것을 확인할 수 있었습니다.  
이용 거리 대비로는 0에서 15분 사이 총 2km의 거리를 이동하는 비율이 높게 나타났습니다.

이러한 이유로 저희는 2km로 데이터를 필터링하여 세부 분석을 진행하게 되었습니다.
--------------->>>>>>--------------------------------
3. 각 데이터의 분석결과를 전처리 및 시각화 과정을 통해 Circuity와의 관계성을 파악한다. 

---------------------------------------------------------
먼저 서초구의 데이터 분석 결과에 대해서 설명하겠습니다.
1. 서초구의 각 행정동의 승차 기록 건수에 대한 히스토그램
서초구 행정동 별 이용 승객 수(또는 태깅 수)의 분석 결과 , 반포3동, 서초3동이 가장 이용승객 수 가 많았고, 방배본동, 반포본동에서 승객 수가 낮게 나타났습니다.
하지만 반포3동, 서초3동에서의 Circuity의 추이는 오히려 낮았고, 방배본동은 오히려 높은 것으로 나타났습니다.

2. 각 동 별 승차 시간 별 이용 승객 수의 히스토그램 분석 결과
비교 분석결과 출퇴근시간대인 6~10시와 16~20시 사이에 가장 많은 승객이 이용하고 있음을 확인할 수 있었습니다.

---------------------------------------------------------

저희는 이 데이터 들 중, 이용 승객 수가 많은 행정동 중 반포3동과, 낮은 행정동 중 내곡동의 두가지 행정동에 대해서 조사를 진행하였습니다.

---------------------------------------------------------

먼저 반포 3동에 대한 결과입니다.
히스토그램 분석결과 6~10시사이와, 16~20시 사이가 가장 많은 승객이 이용하는 것으로 파악되었습니다. 
총 이용승객수는 72200건으로 타 행정동 대비 가장 많은 이용 기록이 있는 행정동입니다.
folium을 이용한 clustering 결과, 반포3동 내에 고속터미널역 인근에서 4만건 이상의 태깅이 기록되었고, 가장 많은 승객이 이용하는 혼잡한 역이라는 것을 파악 할 수 있었습니다.

다음은 distance를 2km로 제한 하였을 경우의 결과입니다.
6~24시까지의 승차 위치와 하차 위치를 위 경도 데이터를 이용하여 파악하고, 각 거리를 선으로 이었습니다. 각 컬러별로 초록색이 우회계수 1~1.1, 노랑 1.1~1.2, 블루 1.2~1.3, 빨강이 1.3 이상의 데이터입니다.
서초구의 평균 circuity는 1.28로, 1.3이상의 데이터를 우회계수가 높다고 판단하고, 1.3이상의 데이터에 대하여 추가적인 분석을 진행하였습니다.

----
출근시간(6~10시 사이에 이용 승객 추이)

분석결과 출근시간에 따라서 이용 승객이 증가하고 있음을 확인할 수 있었는데, 시간이 늘어남으로써 선은 증가하지만 Circuity가 높은 빨강색의 선 자체는 크게 증가하지 않는 것으로 파악되었습니다.
파란 선과 빨강 선이 밀집된 구역을 분석결과, 반포3동의 경우 신사역 부근으로 오는 경우, 아파트 단지와 각 구역들의 직각성으로 인해 우회계수가 높은 것으로 추론되었습니다. 

퇴근 시간의 경우도 마찬가지로 신사역 부근에서의 우회계수가 높게 나타났습니다. 

-----------------

전체 통계로 확인했을 때, 인구밀집도에 따라 지리적으로 우회계수가 낮은 경로를 사용하는 이용 승객이 많았기 떄문에 반포 3동 자체의 우회계수가 낮은 것으로 판단되었습니다.

---------------

#이에 따라서 인구밀도와 Circuity는 유의미한 차이를 가질 것인가 가설 검정이 필요해보이는 것으로 판단되었습니다.
#각 데이터에서 t-분포 분석결과, 0.05 유의수준 ~~~ 유의미한 차이를 가지고 있지 않다는 사실로 검정하였습니다.

-------------------------------------------

다만, 공유킥보드와 공유자전거의 특성상, 우회 경로뿐 아니라 이용 승객, 즉 수요 또한 변수에 큰 영향을 받는다고 판단하였기 때문에, 이 행정동의 따릉이 및 공유 킥보드 분포에 대해서 살펴보았습니다.
따릉이는 서초구 내에 이미 많은 공유자전거가 보급이 되어있었고, 서초, 강남의 경우에도 공유 킥보드가 많이 서비스가 제공이 되고 있었습니다. 이에 따라서, 2km이내에 큰 우회계수를 갖는 취약지점이 존재하였으나, 이미 보급되어 있는 서비스로도 
충분할 것이라 판단이 되었습니다.

------------------------------------------
다음은 방배1동에 대한 결과입니다.

히스토그램 분석결과 6~10시사이와, 16~20시 사이가 가장 많은 승객이 이용하는 것으로 파악되었습니다. 
총 이용승객수는 23134건으로 타 행정동 대비 가장 많은 이용 기록이 있는 행정동입니다.
folium을 이용한 clustering 결과, 방배1동 내에 고속터미널역 인근에서 4만건 이상의 태깅이 기록되었고, 가장 많은 승객이 이용하는 혼잡한 역이라는 것을 파악 할 수 있었습니다.

다음은 distance를 2km로 제한 하였을 경우의 결과입니다.
6~24시까지의 승차 위치와 하차 위치를 위 경도 데이터를 이용하여 파악하고, 각 거리를 선으로 이었습니다. 각 컬러별로 초록색이 우회계수 1~1.1, 노랑 1.1~1.2, 블루 1.2~1.3, 빨강이 1.3 이상의 데이터입니다.
서초구의 평균 circuity는 1.28로, 1.3이상의 데이터를 우회계수가 높다고 판단하고, 1.3이상의 데이터에 대하여 추가적인 분석을 진행하였습니다.

----
출근시간(6~10시 사이에 이용 승객 추이)

분석결과 방배1동 역시 출, 퇴근시간에 따라서 이용 승객이 증가하고 있음을 확인할 수 있었는데, 시간이 늘어남으로써 선은 증가하지만 Circuity가 높은 푸른색이나 빨강색의 선 자체는 크게 증가하지 않는 것으로 파악되었습니다.
파란 선과 빨강 선이 밀집된 구역을 분석결과, 방배1동의 경우 내방역 부근으로 오는 경우, 아파트 단지와 각 구역들의 직각성, 지리적으로 산을 우회해서 와야하는 이용 경로로 인해 우회계수가 높은 것으로 추론되었습니다. 하지만 방배1동의 경우또한 

전체적인 분포 중 1.2 이하의 초록선이 압도적으로 비율이 높았기 때문에 우회계수의 평균값은 낮게 나온 것으로 추론되었습니다.
퇴근 시간의 경우도 마찬가지로 내방역 부근에서의 우회계수가 높게 나타났습니다. 

-----------------

전체 통계로 확인했을 때, 방배1동의 경우도 인구밀집도에 따라 지리적으로 우회계수가 낮은 경로를 사용하는 이용 승객이 많았기 떄문에 방배 1동 자체의 우회계수가 낮은 것으로 판단되었습니다.

---------------

#이에 따라서 인구밀도와 Circuity는 유의미한 차이를 가질 것인가 가설 검정이 필요해보이는 것으로 판단되었습니다.
#각 데이터에서 t-분포 분석결과, 0.05 유의수준 ~~~ 유의미한 차이를 가지고 있지 않다는 사실로 검정하였습니다.

-------------------------------------------

다만, 공유킥보드와 공유자전거의 특성상, 우회 경로뿐 아니라 이용 승객, 즉 수요 또한 변수에 큰 영향을 받는다고 판단하였기 때문에, 이 행정동의 따릉이 및 공유 킥보드 분포에 대해서 살펴보았습니다.
따릉이는 서초구 내에 이미 많은 공유자전거가 보급이 되어있었고, 서초, 강남의 경우에도 공유 킥보드가 많이 서비스가 제공이 되고 있었습니다. 먼저, 반포3동의 경우는 2km이내에 큰 우회계수를 갖는 취약지점이 존재하였으나, 이미 보급되어 있는 대수가 많았기 때문에
 서비스로도 충분할 것이라 판단이 되었습니다. 방배1동의 경우는 방배역에 비치된 따릉이의 자전거 대수가 부족하고, 우회 지점에서 오는 곳에도 따릉이가 부족했기 때문에, 이 곳에 추가적인 따릉이 배치와, 공유킥보드 배치가 필요하다 예측되었습니다.

------------------------------------------



------------------------------------------
다음은 방배본동에 대한 결과입니다.

히스토그램 분석결과 6~10시사이와, 16~20시 사이가 가장 많은 승객이 이용하는 것으로 파악되었습니다. 
이 방배본동의 경우, 우회계수 평균 그래프에서 평균이 가장 높게 나타났던 행정동중 하나입니다.

총 이용승객수는 5936건의 기록이 있는 행정동입니다.
folium을 이용한 clustering 결과, 방배본동 내에 롯데캐슬아파트 부근에서 1400건 이상의 태깅이 기록되었고,  함지박사거리에서 2천건 이상의 태깅이 기록되었습니다.

다음은 distance를 2km로 제한 하였을 경우의 결과입니다.

----
출근시간(6~10시 사이에 이용 승객 추이)

분석결과 방배본동 역시 출, 퇴근시간에 따라서 이용 승객이 증가하고 있음을 확인할 수 있었는데, 파란 선과 빨강 선이 밀집된 구역을 분석결과 함지박사거리 인근 버스정류장에서 롯데캐슬 아파트나 주변 아파트 단지로 향하는 우회계수가 높은 데이터가 시간이 지남에 따라 증가하고 있음을 확인하였습니다..
, 방배본동의 경우 내방역 부근에서 버스를 타고 주변 주거지로 오는 경우, 아파트 단지와 각 구역들의 직각성, 국립서울현충원을 우회해서 와야하는 이용 경로, 그리고 특정 노선을 이용하는 승객 수가 많아 우회계수가 높은 것으로 추론되었습니다. 

전체적인 분포 중 1.3 이상의 파랑과 빨간선의 비율이 높았기 때문에 우회계수의 평균값은 낮게 나온 것으로 추론되었습니다.
퇴근 시간의 경우도 마찬가지로 내방역 부근에서의 우회계수가 높게 나타났습니다. 

-----------------

#이에 따라서 인구밀도와 Circuity는 유의미한 차이를 가질 것인가 가설 검정이 필요해보이는 것으로 판단되었습니다.
#각 데이터에서 t-분포 분석결과, 0.05 유의수준 ~~~ 유의미한 차이를 가지고 있지 않다는 사실로 검정하였습니다.

-------------------------------------------
다음은 공유킥보드와 공유자전거에 배치에 따라 위 취약지점에 배치가 가능한가에 대해 알아보았습니다. 

따릉이는 서초구 내에 이미 많은 공유자전거가 보급이 되어있었고, 서초, 강남의 경우에도 공유 킥보드가 많이 서비스가 제공이 되고 있었습니다. 먼저, 반포3동의 경우는 2km이내에 큰 우회계수를 갖는 취약지점이 존재하였으나, 이미 보급되어 있는 대수가 많았기 때문에
 서비스로도 충분할 것이라 판단이 되었습니다. 방배1동의 경우는 방배역에 비치된 따릉이의 자전거 대수가 부족하고, 우회 지점에서 오는 곳에도 따릉이가 부족했기 때문에, 이 곳에 추가적인 따릉이 배치와, 공유킥보드 배치가 필요하다 예측되었습니다. 방배본동의 경우는

이수역 부근에서 우회계수가 높았던 주거지 까지 따릉이 배치가 부족해보이는 것으로 판단 되었습니다. 이곳에 더 추가적이 배치와 공유킥보드의 배치가 필요하다고 예측이 되었습니다.

다만, 공유킥보드와 공유자전거의 특성상, 우회 경로뿐 아니라 이용 승객, 즉 수요 또한 변수에 포함해야하므로 이 또한 추가적인 고려가 필요할 것으로 보입니다.
------------------------------------------
### 해야할일

1. 시군구별로 데이터를 분리하기
2. Circuity가 높은 4개의 시군구를 중심으로 데이터를 분석하기.. 시군구명칭 pivot_table
 - 서초구, 양천구, 중랑구, 서대문구를 중심으로 데이터 분석.
 - 유의미한 Circuity 데이터 추출을 위해서
 - 대중교통이 취약한 부분은 혼잡하고, 돌아가는 지점 . Circuity > 1.0
 - Circuity가 1.0보다 아래인 지점은 정제
 - 거시적으로는 문제 배경을 잡는 것을 중심으로, 미시적으로는 자세하게 분석.
 - 특정 행정동의 혼잡 경로 중심으로 분석할 것이므로, total distance를 적게 잡을 필요성 있음.
 - crosstab으로 특정 구에 해당하는 데이터만 원본데이터에서 추출하고, 경로를 특정하자.
 - Circuity가 3.0이상인 데이터에 대해서는 고려하지 않음(why? 극단적으로 높은 Circuity는 분류해서 확인할 필요가 있고, 오류로 인해 높은 경우가 있음)
3. 어떤 관계성을 데이터 분석할까?
4. 대중교통 이용승객 수와 도로교통별 혼잡 우회계수와 상관관계가 있을까??